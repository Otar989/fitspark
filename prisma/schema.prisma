// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model users {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auth_id     String   @unique @db.Uuid
  username    String?  @unique
  email       String?
  avatar_url  String?
  created_at  DateTime @default(now()) @db.Timestamptz
  updated_at  DateTime @default(now()) @db.Timestamptz

  // Relations
  user_challenge user_challenge[]
  completions    completions[]
  subscriptions  subscriptions[]
  user_badges    user_badges[]
  user_scores    user_scores[]

  @@map("users")
}

model challenges {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  description   String?
  target        Int      @default(1)
  unit          String   @default("times")
  icon          String   @default("üéØ")
  category      String   @default("general")
  premium       Boolean  @default(false)
  active        Boolean  @default(true)
  duration_days Int      @default(30)
  created_at    DateTime @default(now()) @db.Timestamptz

  // Relations
  user_challenge user_challenge[]
  completions    completions[]
  badges         badges[]

  @@map("challenges")
}

model user_challenge {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String    @db.Uuid
  challenge_id String    @db.Uuid
  start_date   DateTime  @default(dbgenerated("current_date")) @db.Date
  end_date     DateTime? @db.Date
  completed    Boolean   @default(false)
  created_at   DateTime  @default(now()) @db.Timestamptz

  // Relations
  user      users      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  challenge challenges @relation(fields: [challenge_id], references: [id], onDelete: Cascade)

  @@unique([user_id, challenge_id])
  @@map("user_challenge")
}

model completions {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String   @db.Uuid
  challenge_id String   @db.Uuid
  value        Decimal  @default(1)
  proof_url    String?
  completed_at DateTime @default(dbgenerated("current_date")) @db.Date
  points       Int      @default(0)
  created_at   DateTime @default(now()) @db.Timestamptz

  // Relations
  user      users      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  challenge challenges @relation(fields: [challenge_id], references: [id], onDelete: Cascade)

  @@unique([user_id, challenge_id, completed_at])
  @@map("completions")
}

model subscriptions {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String    @db.Uuid
  status                String // 'active', 'canceled', 'past_due', 'trialing'
  current_period_start  DateTime? @db.Timestamptz
  current_period_end    DateTime? @db.Timestamptz
  cancel_at_period_end  Boolean   @default(false)
  created_at            DateTime  @default(now()) @db.Timestamptz
  updated_at            DateTime  @default(now()) @db.Timestamptz

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model badges {
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String  @unique
  description      String?
  icon             String  @default("üèÜ")
  requirement_type String // 'streak', 'total', 'challenge_complete'
  requirement_value Int
  challenge_id     String? @db.Uuid
  created_at       DateTime @default(now()) @db.Timestamptz

  // Relations
  challenge   challenges?   @relation(fields: [challenge_id], references: [id], onDelete: Cascade)
  user_badges user_badges[]

  @@map("badges")
}

model user_badges {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id  String   @db.Uuid
  badge_id String   @db.Uuid
  earned_at DateTime @default(now()) @db.Timestamptz

  // Relations
  user  users  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  badge badges @relation(fields: [badge_id], references: [id], onDelete: Cascade)

  @@unique([user_id, badge_id])
  @@map("user_badges")
}

model profiles {
  id         String   @id @db.Uuid
  username   String?
  updated_at DateTime @default(now()) @db.Timestamptz

  @@map("profiles")
}

model user_scores {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id String @db.Uuid
  score   Int    @default(0)

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_scores")
}
